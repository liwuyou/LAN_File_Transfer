<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“ - ç§»åŠ¨ç«¯</title>
    <link rel="stylesheet" href="/static/mobile/css/style.css">
</head>
<body>
    <div class="container">
        <!-- æ±‰å ¡èœå•æŒ‰é’® -->
        <div class="menu-toggle" id="menuToggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
        
        <!-- çŠ¶æ€åŒº - å·¦ä¾§1/4 -->
        <div class="status-panel" id="statusPanel">
            <div class="user-info">
                <div class="user-avatar">ğŸ‘¤</div>
                <div class="user-name">å½“å‰ç”¨æˆ·</div>
                <button class="refresh-btn" title="åˆ·æ–°çŠ¶æ€">ğŸ”„</button>
                <div class="user-status">åœ¨çº¿</div>
            </div>
            
            <div class="online-users">
                <h4 style="margin-bottom: 15px; color: #bdc3c7;">åœ¨çº¿ç”¨æˆ·</h4>
                
                <div class="online-user">
                    <div class="user-avatar-small">A</div>
                    <div class="user-name-small">Alice</div>
                </div>
                
                <div class="online-user">
                    <div class="user-avatar-small">B</div>
                    <div class="user-name-small">Bob</div>
                </div>
                
                <div class="online-user">
                    <div class="user-avatar-small">C</div>
                    <div class="user-name-small">Charlie</div>
                </div>
                
                <div class="online-user">
                    <div class="user-avatar-small">D</div>
                    <div class="user-name-small">David</div>
                </div>
            </div>
        </div>
        
        <!-- äº¤äº’åŒº - å³ä¾§3/4 -->
        <div class="interaction-panel">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- æ¶ˆæ¯å°†åŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
                    <div class="message system-message">
                        <div class="message-content">
                            <div class="message-text">æ¬¢è¿ä½¿ç”¨LANæ–‡ä»¶ä¼ è¾“ç³»ç»Ÿï¼</div>
                            <div class="message-time">åˆšåˆš</div>
                        </div>
                    </div>

                    <div class="message system-message">
                        <div class="message-content">
                            <div class="message-text">å·¦ä¾§æ ç‚¹å‡»åˆ·æ–°åï¼Œå¯ä»¥é€‰æ‹©å¯¹åº”çš„ç”¨æˆ·ï¼Œè¦åœ¨ä¸€ä¸ªå±€åŸŸç½‘ä¸‹</div>
                            <div class="message-time">åˆšåˆš</div>
                        </div>
                    </div>

                    <div class="message received-message">
                        <div class="message-avatar">A</div>
                        <div class="message-content">
                            <div class="message-sender">Alice</div>
                            <div class="message-text">ä½ å¥½ï¼éœ€è¦å‘é€ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ</div>
                            <div class="message-time">2åˆ†é’Ÿå‰</div>
                        </div>
                    </div>
                    
                    <div class="message sent-message">
                        <div class="message-content">
                            <div class="message-text">æˆ‘æƒ³å‘é€ä¸€ä¸ªæ–‡æ¡£æ–‡ä»¶</div>
                            <div class="message-time">1åˆ†é’Ÿå‰</div>
                        </div>
                        <div class="message-avatar">æˆ‘</div>
                    </div>

                    <div class="message file-message">
                        <div class="message-avatar">A</div>
                        <div class="message-content">
                            <div class="message-sender">Alice</div>
                            <div class="file-item">
                                <div class="file-icon">ğŸ“„</div>
                                <div class="file-info">
                                    <div class="file-name">é¡¹ç›®æ–‡æ¡£.pdf</div>
                                    <div class="file-size">2.4 MB</div>
                                    <div class="file-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 75%"></div>
                                        </div>
                                        <span class="progress-text">75%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="message-time">æ­£åœ¨ä¼ è¾“...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button class="file-btn">+</button>
                <button class="send-btn">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // è¿™é‡Œå°†æ·»åŠ JavaScriptäº¤äº’é€»è¾‘
        console.log("ç§»åŠ¨ç«¯ç•Œé¢å·²åŠ è½½");
        
        // å¤´åƒåº“å®šä¹‰
        const avatarLibrary = [
            // äººç‰©å¤´åƒ
            'ğŸ§‘', 'ğŸ§’', 'ğŸ‘¶', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ§•', 'ğŸ¤µ', 'ğŸ‘°', 'ğŸ‘³',
            'ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ“', 'ğŸ‘¨â€ğŸ’¼', 'ğŸ‘©â€ğŸ’¼', 'ğŸ‘¨â€ğŸ”§', 'ğŸ‘©â€ğŸ”§',
            'ğŸ‘¨â€ğŸ³', 'ğŸ‘©â€ğŸ³', 'ğŸ‘¨â€ğŸš€', 'ğŸ‘©â€ğŸš€', 'ğŸ‘¨â€âš•ï¸', 'ğŸ‘©â€âš•ï¸', 'ğŸ‘¨â€ğŸŒ¾', 'ğŸ‘©â€ğŸŒ¾',
            
            // åŠ¨ç‰©å¤´åƒ
            'ğŸµ', 'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨',
            'ğŸ¯', 'ğŸ¦', 'ğŸ”', 'ğŸ§', 'ğŸ¸', 'ğŸ ', 'ğŸ™', 'ğŸ¦‰', 'ğŸ¦„', 'ğŸ¦',
            
            // å¥‡å¹»å¤´åƒ
            'ğŸ‘»', 'ğŸ‘½', 'ğŸ¤–', 'ğŸ’€', 'ğŸ˜ˆ', 'ğŸ‘¾', 'ğŸ¦¹', 'ğŸ¦¸', 'ğŸ§™', 'ğŸ§',
            
            // ç‰©å“å¤´åƒ
            'ğŸ­', 'ğŸŒ', 'ğŸŒš', 'ğŸ', 'âš½', 'ğŸ€', 'ğŸ®', 'ğŸ¸', 'ğŸ“±', 'ğŸ’»'
        ];
        
        // åŸºäºç”¨æˆ·IDè·å–ç¡®å®šæ€§å¤´åƒ
        function getAvatarByUserId(userId) {
            if (!userId) return 'ğŸ‘¤'; // é»˜è®¤å¤´åƒ
            
            // å°†ç”¨æˆ·IDè½¬æ¢ä¸ºæ•°å­—å¹¶å–æ¨¡
            const numericId = parseInt(userId.toString().replace(/\D/g, '')) || 0;
            const index = numericId % avatarLibrary.length;
            return avatarLibrary[index];
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                if (response.ok) {
                    const userData = await response.json();
                    updateUserDisplay(userData);
                    
                    // ä¿å­˜å½“å‰ç”¨æˆ·IDåˆ°sessionStorage
                    sessionStorage.setItem('user_id', userData.user_id);
                    sessionStorage.setItem('username', userData.username);
                } else {
                    console.warn('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
            }
        }
        
        function updateUserDisplay(userData) {
            const userNameElement = document.querySelector('.user-name');
            const userAvatarElement = document.querySelector('.user-avatar');
            
            if (userNameElement && userData.username) {
                userNameElement.textContent = userData.username;
            }
            
            // è®¾ç½®åŸºäºç”¨æˆ·IDçš„ç¡®å®šæ€§å¤´åƒ
            if (userAvatarElement && userData.user_id) {
                userAvatarElement.textContent = getAvatarByUserId(userData.user_id);
            }
        }
        
        // èœå•åˆ‡æ¢åŠŸèƒ½
        const menuToggle = document.getElementById('menuToggle');
        const statusPanel = document.getElementById('statusPanel');
        
        menuToggle.addEventListener('click', function() {
            statusPanel.classList.toggle('hidden');
            this.classList.toggle('active');
            
            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            const isHidden = statusPanel.classList.contains('hidden');
            localStorage.setItem('sidebarHidden', isHidden);
        });
        
        // åˆå§‹åŒ–æ—¶æ£€æŸ¥ä¿å­˜çš„çŠ¶æ€
        const savedState = localStorage.getItem('sidebarHidden');
        if (savedState === 'true') {
            statusPanel.classList.add('hidden');
            menuToggle.classList.add('active');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè·å–ç”¨æˆ·ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadOnlineUsers();
            startHeartbeat();
            startMessagePolling();  // å¯åŠ¨æ¶ˆæ¯è½®è¯¢
        });
        
        // æ¶ˆæ¯è½®è¯¢ - æ£€æŸ¥æ–°æ¶ˆæ¯
        function startMessagePolling() {
            setInterval(async () => {
                const selectedUser = document.querySelector('.online-user.selected');
                if (selectedUser && selectedUser.dataset.userId !== sessionStorage.getItem('user_id')) {
                    await checkNewMessages(selectedUser.dataset.userId);
                }
            }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ–°æ¶ˆæ¯
        }
        
        // æ£€æŸ¥æ–°æ¶ˆæ¯
        async function checkNewMessages(targetId) {
            try {
                console.log('ğŸ” æ£€æŸ¥æ–°æ¶ˆæ¯ï¼Œç›®æ ‡ç”¨æˆ·:', targetId);
                
                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
                let lastTimestamp = await getLastMessageTimestamp(targetId);
                console.log('â° æœ€åæ—¶é—´æˆ³:', lastTimestamp);
                
                const url = lastTimestamp 
                    ? `/api/check-new-messages/${targetId}?last_timestamp=${encodeURIComponent(lastTimestamp)}`
                    : `/api/check-new-messages/${targetId}`;
                
                console.log('ğŸŒ è¯·æ±‚URL:', url);
                
                const response = await fetch(url);
                if (response.ok) {
                    const newMessages = await response.json();
                    console.log('ğŸ“¨ æ”¶åˆ°æ–°æ¶ˆæ¯æ•°é‡:', newMessages.length);
                    
                    if (newMessages.length > 0) {
                        // æ˜¾ç¤ºæ–°æ¶ˆæ¯
                        newMessages.forEach(message => {
                            console.log('ğŸ’¬ æ–°æ¶ˆæ¯:', message.content);
                            if (message.type === 'text') {
                                const isSent = message.sender_id.toString() === sessionStorage.getItem('user_id');
                                addTextMessage(message.content, isSent, message.sender_id, message.timestamp);
                            } else if (message.type === 'file') {
                                const isSent = message.sender_id.toString() === sessionStorage.getItem('user_id');
                                addReceivedFileMessage(message, isSent);
                            }
                        });
                    }
                } else {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('âŒ æ£€æŸ¥æ–°æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // è·å–æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
        async function getLastMessageTimestamp(targetId) {
            try {
                const messages = await fetch(`/api/messages/${targetId}`).then(r => r.json());
                if (messages.length > 0) {
                    return messages[messages.length - 1].timestamp;
                }
            } catch (error) {
                console.error('è·å–æ¶ˆæ¯æ—¶é—´æˆ³å¤±è´¥:', error);
            }
            return null;
        }
        
        // åŠ è½½åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        async function loadOnlineUsers() {
            try {
                const response = await fetch('/api/online-users');
                if (response.ok) {
                    const users = await response.json();
                    updateOnlineUsersDisplay(users);
                }
            } catch (error) {
                console.error('åŠ è½½åœ¨çº¿ç”¨æˆ·å¤±è´¥:', error);
            }
        }
        
        function updateOnlineUsersDisplay(users) {
            const onlineUsersContainer = document.querySelector('.online-users');
            const currentUserId = sessionStorage.getItem('user_id');
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„ç”¨æˆ·ID
            const selectedUserId = document.querySelector('.online-user.selected')?.dataset.userId;
            
            onlineUsersContainer.innerHTML = '<h4 style="margin-bottom: 15px; color: #bdc3c7;">åœ¨çº¿ç”¨æˆ·</h4>';
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `online-user ${user.is_online ? 'online' : 'offline'}`;
                userElement.dataset.userId = user.user_id;
                
                // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰è®¾å¤‡
                const displayName = (user.user_id.toString() === currentUserId) ? 'æœ¬è®¾å¤‡' : user.username;
                const userAvatar = getAvatarByUserId(user.user_id);
                
                userElement.innerHTML = `
                    <div class="user-avatar-small">${userAvatar}</div>
                    <div class="user-name-small">${displayName}</div>
                `;
                onlineUsersContainer.appendChild(userElement);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
            if (selectedUserId) {
                const userElement = document.querySelector(`[data-user-id="${selectedUserId}"]`);
                if (userElement) {
                    userElement.classList.add('selected');
                }
            }
            
            // æ·»åŠ ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ç›‘å¬
            attachUserClickEvents();
        }
        
        // æ·»åŠ ç”¨æˆ·ç‚¹å‡»äº‹ä»¶å¤„ç†
        function attachUserClickEvents() {
            const onlineUsers = document.querySelectorAll('.online-user');
            onlineUsers.forEach(userElement => {
                userElement.addEventListener('click', function() {
                    handleUserSelection(this);
                });
            });
        }
        
        // å¤„ç†ç”¨æˆ·é€‰æ‹©
        function handleUserSelection(userElement) {
            const currentUserId = sessionStorage.getItem('user_id');
            const selectedUserId = userElement.dataset.userId;
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.online-user.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // é«˜äº®å½“å‰é€‰æ‹©
            userElement.classList.add('selected');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é€‰æ‹©è‡ªå·±
            if (selectedUserId === currentUserId) {
                showSelfMessageWarning();
            } else {
                // æ­£å¸¸é€‰æ‹©å…¶ä»–ç”¨æˆ·
                clearChatMessages();
                loadChatHistory(selectedUserId);  // åŠ è½½ä¸è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
            }
        }
        
        // æ˜¾ç¤ºè‡ªæˆ‘æ¶ˆæ¯è­¦å‘Š
        function showSelfMessageWarning() {
            const chatMessages = document.getElementById('chatMessages');
            
            // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
            chatMessages.innerHTML = '';
            
            // æ·»åŠ è­¦å‘Šæ¶ˆæ¯
            const warningMessage = document.createElement('div');
            warningMessage.className = 'message system-message';
            warningMessage.innerHTML = `
                <div class="message-content">
                    <div class="message-text">
                        âš ï¸ ä¼šå‘é€çš„æœåŠ¡å™¨ç”µè„‘ï¼Œæ— ç”¨æˆ·æ¥å—
                    </div>
                    <div class="message-time">ç³»ç»Ÿæç¤º</div>
                </div>
            `;
            
            chatMessages.appendChild(warningMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // æ›´æ–°è¾“å…¥åŒºåŸŸæç¤º
            updateInputPlaceholder('æ¶ˆæ¯å°†ä¿å­˜åˆ°æœåŠ¡å™¨...');
        }
        
        // æ›´æ–°è¾“å…¥æ¡†æç¤º
        function updateInputPlaceholder(text) {
            const messageInput = document.querySelector('.message-input');
            messageInput.placeholder = text;
        }
        
        // æ¸…ç©ºèŠå¤©æ¶ˆæ¯
        function clearChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // æ¢å¤é»˜è®¤è¾“å…¥æç¤º
            updateInputPlaceholder('è¾“å…¥æ¶ˆæ¯...');
        }
        
        // åŠ è½½èŠå¤©è®°å½•
        async function loadChatHistory(targetId) {
            try {
                const response = await fetch(`/api/messages/${targetId}`);
                if (response.ok) {
                    const messages = await response.json();
                    displayMessages(messages);
                }
            } catch (error) {
                console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            const currentUserId = sessionStorage.getItem('user_id');
            
            messages.forEach(message => {
                if (message.type === 'text') {
                    // æ–‡æœ¬æ¶ˆæ¯
                    const isSent = message.sender_id.toString() === currentUserId;
                    addTextMessage(message.content, isSent, message.sender_id, message.timestamp);
                } else if (message.type === 'file') {
                    // æ–‡ä»¶æ¶ˆæ¯
                    const isSent = message.sender_id.toString() === currentUserId;
                    addReceivedFileMessage(message, isSent);
                }
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ·»åŠ æ¥æ”¶åˆ°çš„æ–‡ä»¶æ¶ˆæ¯
        function addReceivedFileMessage(messageData, isSent = false) {
            const chatMessages = document.getElementById('chatMessages');
            
            const fileMessage = document.createElement('div');
            fileMessage.className = isSent ? 'message file-message' : 'message received-message file-message';
            
            const fileInfo = messageData.file_info;
            const senderName = isSent ? 'æˆ‘' : `ç”¨æˆ·${messageData.sender_id}`;
            
            fileMessage.innerHTML = `
                <div class="message-avatar">${isSent ? 'ğŸ“„' : '?'}</div>
                <div class="message-content">
                    <div class="message-sender">${senderName}</div>
                    <div class="file-item">
                        <div class="file-icon">${getFileIconByExtension(fileInfo.original_name)}</div>
                        <div class="file-info">
                            <div class="file-name">${fileInfo.original_name}</div>
                            <div class="file-size">${formatFileSize(fileInfo.size)}</div>
                            <button class="download-btn" onclick="downloadFile('${fileInfo.saved_name}', '${messageData.receiver_id}')">
                                ä¸‹è½½æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                    <div class="message-time">${formatTime(messageData.timestamp)}</div>
                </div>
            `;
            
            chatMessages.appendChild(fileMessage);
            scrollToBottom();
        }
        
        // æ ¹æ®æ–‡ä»¶æ‰©å±•åè·å–å›¾æ ‡
        function getFileIconByExtension(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const icons = {
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'bmp': 'ğŸ–¼ï¸',
                'pdf': 'ğŸ“„', 'doc': 'ğŸ“', 'docx': 'ğŸ“', 'txt': 'ğŸ“',
                'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬', 'wmv': 'ğŸ¬',
                'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ',
                'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦',
                'default': 'ğŸ“'
            };
            return icons[extension] || icons.default;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        // æ·»åŠ æ–‡æœ¬æ¶ˆæ¯ï¼ˆå¢å¼ºç‰ˆï¼‰
        function addTextMessage(text, isSent = false, senderId = null, timestamp = null) {
            const chatMessages = document.getElementById('chatMessages');
            
            const textMessage = document.createElement('div');
            textMessage.className = isSent ? 'message sent-message' : 'message received-message';
            
            const senderName = isSent ? 'æˆ‘' : (senderId ? `ç”¨æˆ·${senderId}` : 'å¯¹æ–¹');
            const displayTime = timestamp ? formatTime(timestamp) : 'åˆšåˆš';
            
            if (isSent) {
                textMessage.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${text}</div>
                        <div class="message-time">${displayTime}</div>
                    </div>
                    <div class="message-avatar">${getAvatarByUserId(sessionStorage.getItem('user_id'))}</div>
                `;
            } else {
                textMessage.innerHTML = `
                    <div class="message-avatar">${getAvatarByUserId(senderId)}</div>
                    <div class="message-content">
                        <div class="message-sender">${senderName}</div>
                        <div class="message-text">${text}</div>
                        <div class="message-time">${displayTime}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(textMessage);
            scrollToBottom();
        }

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatContainer = document.querySelector('.chat-container');
            
            if (!chatContainer) {
                return;
            }
            
            setTimeout(() => {
                // æ»šåŠ¨åˆ°æœ€åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }
        
        
        // å•ç‹¬çš„çŠ¶æ€æ›´æ–°å‡½æ•°
        async function updateDeviceStatus() {
            try {
                const response = await fetch('/api/update-status', { method: 'POST' });
                if (response.ok) {
                    console.log('âœ“ è®¾å¤‡çŠ¶æ€å·²æ›´æ–°');
                    return true;
                } else {
                    console.warn('âš  çŠ¶æ€æ›´æ–°å¤±è´¥');
                    return false;
                }
            } catch (error) {
                console.error('âŒ çŠ¶æ€æ›´æ–°é”™è¯¯:', error);
                return false;
            }
        }
        
        // å¿ƒè·³æ£€æµ‹ - å®šæœŸæ›´æ–°çŠ¶æ€
        function startHeartbeat() {
            setInterval(async () => {
                await updateDeviceStatus();  // æ›´æ–°æœ¬è®¾å¤‡çŠ¶æ€
                // æ³¨æ„ï¼šè¿™é‡Œä¸è°ƒç”¨ loadOnlineUsers() æ¥é¿å…é¢‘ç¹åˆ·æ–°é€‰æ‹©çŠ¶æ€
            }, 60000); // æ¯åˆ†é’Ÿä¸€æ¬¡
        }
        
        // åˆ·æ–°æŒ‰é’®åŠŸèƒ½ - ç«‹å³å‘é€å¿ƒè·³åŒ…å¹¶è·å–çŠ¶æ€
        const refreshBtn = document.querySelector('.refresh-btn');
        refreshBtn.addEventListener('click', async function() {
            this.classList.add('refreshing');
            
            try {
                // 1. ç«‹å³å‘é€å¿ƒè·³åŒ…æ›´æ–°å½“å‰è®¾å¤‡çŠ¶æ€
                await updateDeviceStatus();
                
                // 2. è·å–å¹¶æ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡çš„æœ€æ–°çŠ¶æ€
                await loadOnlineUsers();
                
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
            } finally {
                setTimeout(() => this.classList.remove('refreshing'), 500);
            }
        });
        
        // æ–‡ä»¶é€‰æ‹©åŠŸèƒ½ - ç§»åŠ¨ç«¯ä¼˜åŒ–
        const fileBtn = document.querySelector('.file-btn');
        
        // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = true;
        fileInput.accept = '*/*';  // æ¥å—æ‰€æœ‰æ–‡ä»¶ç±»å‹
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        
        // æ·»åŠ è§¦æ‘¸åé¦ˆ
        fileBtn.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.95)';
        });
        
        fileBtn.addEventListener('touchend', function() {
            this.style.transform = '';
        });
        
        fileBtn.addEventListener('click', function() {
            fileInput.click();  // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
        });
        
        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            
            if (files.length === 0) return;
            
            // æ˜¾ç¤ºç®€å•çš„åŠ è½½æç¤º
            const originalText = fileBtn.textContent;
            fileBtn.textContent = 'ä¸Šä¼ ä¸­...';
            fileBtn.disabled = true;
            
            for (const file of files) {
                try {
                    console.log('é€‰æ‹©æ–‡ä»¶:', file.name, formatFileSize(file.size));
                    await uploadFile(file);
                } catch (error) {
                    console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                    alert(`æ–‡ä»¶ ${file.name} å¤„ç†å¤±è´¥`);
                }
            }
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            fileBtn.textContent = originalText;
            fileBtn.disabled = false;
            
            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            fileInput.value = '';
        });
        
        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile(file) {
            const selectedUser = document.querySelector('.online-user.selected');
            if (!selectedUser) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·');
                return;
            }
            
            const targetId = selectedUser.dataset.userId;
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('file', file);
            formData.append('target_id', targetId);
            
            try {
                const response = await fetch('/api/send-file', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', result);
                    
                    // æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯
                    addFileMessage(file, result.message);
                    
                    // å¦‚æœæ˜¯å‘é€ç»™è‡ªå·±ï¼Œæ˜¾ç¤ºæœåŠ¡å™¨ä¿å­˜æç¤º
                    const currentUserId = sessionStorage.getItem('user_id');
                    if (targetId === currentUserId) {
                        addSystemMessage('æ–‡ä»¶å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                    }
                } else {
                    const error = await response.json();
                    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                    alert(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.error}`);
                }
            } catch (error) {
                console.error('ä¸Šä¼ æ–‡ä»¶é”™è¯¯:', error);
                alert('ä¸Šä¼ æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }
        
        // æ·»åŠ æ–‡ä»¶æ¶ˆæ¯ï¼ˆä¿®æ”¹åçš„ç‰ˆæœ¬ï¼‰
        function addFileMessage(file, messageData = null) {
            const chatMessages = document.getElementById('chatMessages');
            
            const fileMessage = document.createElement('div');
            fileMessage.className = 'message file-message';
            
            const fileInfo = messageData ? messageData.file_info : {
                original_name: file.name,
                size: file.size
            };
            
            fileMessage.innerHTML = `
                <div class="message-avatar">ğŸ“„</div>
                <div class="message-content">
                    <div class="message-sender">æˆ‘</div>
                    <div class="file-item">
                        <div class="file-icon">${getFileIcon(file.type)}</div>
                        <div class="file-info">
                            <div class="file-name">${fileInfo.original_name}</div>
                            <div class="file-size">${formatFileSize(fileInfo.size)}</div>
                            ${messageData ? `
                            <button class="download-btn" onclick="downloadFile('${fileInfo.saved_name}', '${messageData.receiver_id}')">
                                ä¸‹è½½æ–‡ä»¶
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="message-time">${messageData ? 'å·²å‘é€' : 'å·²é€‰æ‹©'}</div>
                </div>
            `;
            
            chatMessages.appendChild(fileMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ä¸‹è½½æ–‡ä»¶
        async function downloadFile(filename, userId) {
            try {
                const downloadUrl = `/api/download-file/${filename}?user_id=${userId}`;
                window.open(downloadUrl, '_blank');
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶é”™è¯¯:', error);
                alert('ä¸‹è½½æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }
        
        // å‘é€æ¶ˆæ¯åŠŸèƒ½
        const sendBtn = document.querySelector('.send-btn');
        const messageInput = document.querySelector('.message-input');
        
        sendBtn.addEventListener('click', async function() {
            const message = messageInput.value.trim();
            if (message) {
                await sendTextMessage(message);
                messageInput.value = '';
            }
        });
        
        // å‘é€æ–‡æœ¬æ¶ˆæ¯
        async function sendTextMessage(content) {
            const selectedUser = document.querySelector('.online-user.selected');
            if (!selectedUser) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·');
                return;
            }
            
            const targetId = selectedUser.dataset.userId;
            
            try {
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_id: targetId,
                        content: content
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('æ¶ˆæ¯å‘é€æˆåŠŸ:', result);
                    
                    // åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºæ¶ˆæ¯
                    addTextMessage(content, true, null, new Date().toISOString());
                    
                    // å¦‚æœæ˜¯å‘é€ç»™è‡ªå·±ï¼Œæ˜¾ç¤ºæœåŠ¡å™¨ä¿å­˜æç¤º
                    const currentUserId = sessionStorage.getItem('user_id');
                    if (targetId === currentUserId) {
                        addSystemMessage('æ¶ˆæ¯å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                    }
                } else {
                    console.error('æ¶ˆæ¯å‘é€å¤±è´¥');
                    alert('æ¶ˆæ¯å‘é€å¤±è´¥');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
                alert('å‘é€æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            
            const systemMessage = document.createElement('div');
            systemMessage.className = 'message system-message';
            systemMessage.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${text}</div>
                    <div class="message-time">ç³»ç»Ÿæç¤º</div>
                </div>
            `;
            
            chatMessages.appendChild(systemMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // å›è½¦å‘é€æ¶ˆæ¯
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
        
        // è¾…åŠ©å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
        }
        
        function getFileIcon(fileType) {
            const icons = {
                'image/': 'ğŸ–¼ï¸',
                'video/': 'ğŸ¬',
                'audio/': 'ğŸµ',
                'text/': 'ğŸ“',
                'application/pdf': 'ğŸ“„',
                'application/zip': 'ğŸ“¦',
                'default': 'ğŸ“'
            };
            
            for (const [key, icon] of Object.entries(icons)) {
                if (fileType.startsWith(key)) return icon;
            }
            return icons.default;
        }
    </script>
</body>
</html>
